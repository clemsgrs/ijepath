data:
  slide_manifest_csv: data/tcga-prad/manifests/tcga_prad_slides_with_tissue_masks.csv
  slide_metadata_index_jsonl: data/tcga-prad/indexes/slide_metadata_index.jsonl
  anchor_catalog_csv: data/tcga-prad/indexes/anchors_profile_ctx1p0_tgt0p5_fov512um_k4.csv

  batch_size_per_gpu: 32
  num_workers: 16
  low_anchor_pass_warning_threshold: 1.0
  high_anchor_pass_warning_threshold: 5.0

meta:
  architecture: vit_small
  patch_size: 16
  pred_depth: 3
  pred_emb_dim: 192
  use_bfloat16: true
  load_checkpoint: false

optimization:
  total_images_budget: 100000
  warmup: 0.1  # Fraction of total optimization steps.
  lr: 0.0002
  start_lr: 0.00002
  final_lr: 0.000001
  weight_decay: 0.04
  final_weight_decay: 0.1
  ema: [0.996, 1.0]

tuning:
  enable: true
  seed: 0
  schedule:
    interval_images: 10000
    run_baseline_at_zero: true
  plugins:
    - type: pathorob
      enable: true
      use_for_early_stopping: true
      early_stopping_metric: camelyon/apd_avg
      early_stopping_mode: max
      batch_size_per_gpu: ${data.batch_size_per_gpu}
      num_workers: ${data.num_workers}
      transforms:
        resize: 256
        crop_size: null
        normalize: imagenet
      datasets:
        camelyon:
          enable: true
          manifest_csv: data/pathorob/camelyon_manifest.csv
          id_centers: ["RUMC", "UMCU"]
          ood_centers: ["CWZ", "RST", "LPON"]
      ri:
        enable: true
        k_candidates: [3, 5, 7, 10, 15]
      apd:
        enable: true
        mode: paper
        repetitions: 3
        id_test_fraction: 0.2
      clustering:
        enable: true
        repeats: 5
        k_min: 2
        k_max: 10
  early_stopping:
    enable: true
    patience_evals: 5
    min_evals: 3
    stop_training: false  # If true, terminate JEPA training once the early-stopping criterion is met.
    save_best_checkpoint: true
    best_checkpoint_name: best-robustness.pth.tar

logging:
  folder: outputs/pathorob-camelyon-image-budget
  write_tag: jepa-pathorob
  step_log_every_iters: 0
  checkpoint_every_images: 100000

wandb:
  enable: true
  exp_name: pathorob-camelyon
