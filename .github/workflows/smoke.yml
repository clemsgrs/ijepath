name: Smoke (Docker)

on:
  pull_request:
    paths:
      - "Dockerfile.ci"
      - "Dockerfile"
      - "requirements.in"
      - "main.py"
      - "main_distributed.py"
      - "ijepath/config_loading.py"
      - "ijepath/train.py"
      - "ijepath/train_cross_resolution_jepa.py"
      - "ijepath/datasets/**"
      - "ijepath/masks/**"
      - "scripts/build_slide_metadata_index_from_manifest.py"
      - "scripts/build_valid_context_anchor_catalog.py"
      - "scripts/verify_training_runtime.py"
      - "configs/defaults.yaml"
      - "configs/profiles/default.yaml"
      - "configs/profiles/ctx1p0_tgt0p5_fov512um_k4.yaml"
      - "configs/runs/default.yaml"
      - "configs/runs/smoke.yaml"
      - "tests/test_pipeline_integration.py"
      - "data/test-fixtures/test-wsi.tif"
      - "data/test-fixtures/test-mask.tif"
  workflow_dispatch:

jobs:
  docker-smoke:
    name: Build Docker + Run Integration Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build --tag ijepath-smoke-ci:latest --file Dockerfile.ci .

      - name: Run integration smoke test
        run: |
          docker run --rm \
            -e MPLCONFIGDIR=/tmp/mpl \
            ijepath-smoke-ci:latest \
            python -m pytest -m integration tests/test_pipeline_integration.py
